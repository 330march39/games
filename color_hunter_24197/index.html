<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Color Hunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f5f5f7;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .game-container {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        }

        /* Tile Animation */
        .tile {
            transition: transform 0.1s ease, opacity 0.2s;
            cursor: pointer;
        }
        .tile:active {
            transform: scale(0.95);
        }

        /* Wrong Answer Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        
        /* Pop Animation for New Record */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #e11d48; }
            100% { transform: scale(1); }
        }
        .pop-anim {
            animation: pop 0.3s ease-in-out;
        }

        /* Background Tile Pulse */
        @keyframes pulse-color {
            0% { opacity: 0.4; transform: scale(0.95); }
            50% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0.4; transform: scale(0.95); }
        }
        .bg-tile {
            animation: pulse-color 4s infinite ease-in-out;
        }

        /* Modern Scrollbar hide */
        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center text-slate-800 bg-slate-50">

    <!-- Main App Container -->
    <div id="app" class="relative w-full max-w-md h-full max-h-[900px] flex flex-col p-6">
        
        <!-- Header / HUD -->
        <header class="flex justify-between items-end mb-4 h-16 opacity-0 transition-opacity duration-500 z-10" id="hud">
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">Time</span>
                <span id="timerDisplay" class="text-3xl font-bold tabular-nums leading-none text-slate-700">60.00</span>
            </div>
            
            <!-- Removed Best Score Display from HUD here -->

            <div class="flex flex-col items-end">
                <span class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">Score</span>
                <span id="scoreDisplay" class="text-3xl font-bold tabular-nums leading-none text-indigo-600">0</span>
            </div>
        </header>

        <!-- Timer Bar -->
        <div class="w-full h-1.5 bg-slate-200 rounded-full mb-6 overflow-hidden opacity-0 transition-opacity duration-500 z-10" id="timerBarContainer">
            <div id="timerBar" class="h-full bg-indigo-500 rounded-full w-full transition-all duration-100 ease-linear"></div>
        </div>

        <!-- Game Board Area -->
        <main class="flex-grow flex items-center justify-center w-full relative z-10">
            
            <!-- Start Screen with Decorative Background -->
            <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center z-20 overflow-hidden rounded-3xl">
                
                <!-- Decorative Background Tiles -->
                <div id="bgDecoration" class="absolute inset-0 grid grid-cols-4 grid-rows-4 gap-4 p-4 opacity-30 pointer-events-none">
                    <!-- JS will fill this -->
                </div>

                <!-- Glassmorphism Content Card -->
                <div class="relative z-10 bg-white/80 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-xs flex flex-col items-center border border-white/50">
                    <div class="mb-6 flex items-center justify-center w-16 h-16 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-2xl shadow-lg transform -rotate-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                    </div>

                    <h1 class="text-4xl font-black mb-2 tracking-tight text-slate-800 text-center leading-none">
                        Color<br><span class="text-indigo-600">Hunter</span>
                    </h1>
                    <p class="text-slate-500 mb-8 text-xs font-bold uppercase tracking-widest text-center">違う色を見つけろ</p>
                    
                    <div class="w-full flex justify-between items-end px-4 py-3 bg-slate-100 rounded-xl mb-6 border border-slate-200">
                        <span class="text-xs font-bold text-slate-400 uppercase">Best Score</span>
                        <span id="highScoreDisplay" class="text-2xl font-black text-slate-700 tabular-nums">0</span>
                    </div>

                    <button onclick="startGame()" class="w-full group relative px-8 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 active:translate-y-0 overflow-hidden">
                        <span class="relative z-10 flex items-center justify-center gap-2">
                            PLAY NOW
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <div class="absolute inset-0 bg-indigo-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
                    </button>
                </div>
            </div>

            <!-- Game Grid -->
            <div id="gameBoard" class="grid gap-3 w-full aspect-square bg-white p-3 rounded-3xl shadow-xl shadow-indigo-100 hidden transition-all ring-1 ring-slate-100">
                <!-- Tiles will be injected here -->
            </div>

            <!-- Result Screen -->
            <div id="resultScreen" class="absolute inset-0 flex flex-col items-center justify-center z-30 bg-white/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 rounded-3xl">
                <div id="newRecordBadge" class="hidden mb-4 bg-yellow-400 text-yellow-900 px-4 py-1 rounded-full text-xs font-black uppercase tracking-widest shadow-lg transform rotate-[-3deg]">
                    New Record!
                </div>
                
                <p class="text-sm text-slate-400 font-bold uppercase tracking-widest mb-2">Time Up</p>
                <h2 class="text-7xl font-black text-slate-800 mb-2 tracking-tighter" id="finalScore">0</h2>
                <p class="text-xl font-bold text-indigo-600 mb-8" id="rankTitle">Normal</p>
                
                <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                    <button onclick="resetGame()" class="px-4 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-colors text-sm">
                        ホーム
                    </button>
                    <button onclick="startGame()" class="px-4 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-600 transition-colors hover:shadow-xl text-sm">
                        もう一度
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer Removed -->
    </div>

    <script>
        /* --- Game Config & State --- */
        const CONFIG = {
            initialTime: 60,
            penaltyTime: 3,
            maxGridSize: 8,
        };

        let state = {
            score: 0,
            highScore: 0,
            isPlaying: false,
            timeLeft: CONFIG.initialTime,
            timerInterval: null,
            gridSize: 2,
            targetColorIndex: 0,
            isNewRecord: false
        };

        // DOM Elements
        const startScreen = document.getElementById('startScreen');
        const resultScreen = document.getElementById('resultScreen');
        const gameBoard = document.getElementById('gameBoard');
        const hud = document.getElementById('hud');
        const timerBarContainer = document.getElementById('timerBarContainer');
        const timerBar = document.getElementById('timerBar');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const finalScoreEl = document.getElementById('finalScore');
        const rankTitleEl = document.getElementById('rankTitle');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const newRecordBadge = document.getElementById('newRecordBadge');
        const bgDecoration = document.getElementById('bgDecoration');

        /* --- Initialization --- */
        
        // Load High Score
        state.highScore = parseInt(localStorage.getItem('colorHunterHighScore') || '0');
        updateHighScoreDisplays();
        
        // Create Background Decoration
        createBackgroundDecoration();

        /* --- Core Logic --- */

        function startGame() {
            state.score = 0;
            state.timeLeft = CONFIG.initialTime;
            state.isPlaying = true;
            state.isNewRecord = false;
            
            // UI Updates
            scoreDisplay.textContent = '0';
            scoreDisplay.classList.remove('text-yellow-500'); // Reset color
            updateTimerUI();
            
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            resultScreen.classList.remove('opacity-100');
            newRecordBadge.classList.add('hidden');
            
            hud.classList.remove('opacity-0');
            timerBarContainer.classList.remove('opacity-0');
            gameBoard.classList.remove('hidden');

            generateLevel();
            startTimer();
        }

        function resetGame() {
            state.isPlaying = false;
            clearInterval(state.timerInterval);
            
            gameBoard.classList.add('hidden');
            hud.classList.add('opacity-0');
            timerBarContainer.classList.add('opacity-0');
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            
            // Regenerate background for freshness
            createBackgroundDecoration(); 
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                if (!state.isPlaying) return;

                state.timeLeft -= 0.1;
                
                if (state.timeLeft <= 0) {
                    state.timeLeft = 0;
                    gameOver();
                }
                updateTimerUI();
            }, 100);
        }

        function updateTimerUI() {
            timerDisplay.textContent = state.timeLeft.toFixed(2);
            const percentage = (state.timeLeft / CONFIG.initialTime) * 100;
            timerBar.style.width = `${Math.max(0, percentage)}%`;
            
            if (percentage < 20) {
                timerBar.className = 'h-full rounded-full w-full transition-all duration-100 ease-linear bg-red-500';
            } else if (percentage < 50) {
                timerBar.className = 'h-full rounded-full w-full transition-all duration-100 ease-linear bg-yellow-500';
            } else {
                timerBar.className = 'h-full rounded-full w-full transition-all duration-100 ease-linear bg-indigo-500';
            }
        }

        function generateLevel() {
            gameBoard.innerHTML = '';
            state.gridSize = Math.min(CONFIG.maxGridSize, Math.floor((state.score + 4) / 3) + 1);
            if (state.score < 3) state.gridSize = 2;

            gameBoard.style.gridTemplateColumns = `repeat(${state.gridSize}, 1fr)`;

            const colors = generateColors(state.score);
            const totalTiles = state.gridSize * state.gridSize;
            state.targetColorIndex = Math.floor(Math.random() * totalTiles);

            for (let i = 0; i < totalTiles; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile w-full h-full rounded-xl shadow-sm';
                const isTarget = i === state.targetColorIndex;
                tile.style.backgroundColor = isTarget ? colors.target : colors.base;
                tile.ontouchstart = (e) => { e.preventDefault(); handleInteraction(i); };
                tile.onclick = () => handleInteraction(i);
                gameBoard.appendChild(tile);
            }
        }

        function handleInteraction(index) {
            if (!state.isPlaying) return;

            if (index === state.targetColorIndex) {
                // Correct!
                state.score++;
                scoreDisplay.textContent = state.score;
                
                // Check for High Score update in real-time
                if (state.score > state.highScore) {
                    state.highScore = state.score;
                    state.isNewRecord = true;
                    updateHighScoreDisplays();
                    
                    // Visual feedback for breaking record
                    scoreDisplay.classList.add('text-yellow-500');
                }

                generateLevel();
            } else {
                // Wrong!
                penalize();
            }
        }

        function penalize() {
            gameBoard.classList.add('shake');
            setTimeout(() => gameBoard.classList.remove('shake'), 300);

            state.timeLeft -= CONFIG.penaltyTime;
            if (state.timeLeft < 0) state.timeLeft = 0;
            
            timerDisplay.classList.add('text-red-500');
            setTimeout(() => timerDisplay.classList.remove('text-red-500'), 300);
            
            updateTimerUI();
            if (state.timeLeft === 0) gameOver();
        }

        function generateColors(score) {
            const hue = Math.floor(Math.random() * 360);
            const saturation = Math.floor(Math.random() * 30) + 60;
            const lightness = Math.floor(Math.random() * 40) + 30;

            let delta = Math.max(2, 25 - Math.floor(score * 0.8)); 
            const isLighter = Math.random() > 0.5;
            let targetLightness = isLighter ? lightness + delta : lightness - delta;

            if (targetLightness > 100) targetLightness = lightness - delta;
            if (targetLightness < 0) targetLightness = lightness + delta;

            return {
                base: `hsl(${hue}, ${saturation}%, ${lightness}%)`,
                target: `hsl(${hue}, ${saturation}%, ${targetLightness}%)`
            };
        }

        function gameOver() {
            state.isPlaying = false;
            clearInterval(state.timerInterval);

            // Save High Score
            if (state.score >= state.highScore) {
                localStorage.setItem('colorHunterHighScore', state.score);
                state.highScore = state.score;
            }

            const rank = getRank(state.score);

            finalScoreEl.textContent = state.score;
            rankTitleEl.textContent = rank.title;
            rankTitleEl.style.color = rank.color;

            // New Record Badge Logic
            if (state.isNewRecord && state.score > 0) {
                newRecordBadge.classList.remove('hidden');
            }

            resultScreen.classList.remove('hidden');
            setTimeout(() => resultScreen.classList.remove('opacity-0'), 10);
        }

        function updateHighScoreDisplays() {
            highScoreDisplay.textContent = state.highScore;
            // Removed hudBestScore update
        }

        function createBackgroundDecoration() {
            bgDecoration.innerHTML = '';
            // 4x4 grid of random colored tiles
            for(let i=0; i<16; i++) {
                const div = document.createElement('div');
                const hue = Math.floor(Math.random() * 360);
                div.className = 'w-full h-full rounded-2xl bg-tile';
                div.style.backgroundColor = `hsl(${hue}, 70%, 85%)`;
                div.style.animationDelay = `${Math.random() * 2}s`; // Random delay for organic feel
                bgDecoration.appendChild(div);
            }
        }

        function getRank(score) {
            if (score < 10) return { title: "一般人 (Normal)", color: "#64748b" };
            if (score < 20) return { title: "色彩のアマチュア (Amateur)", color: "#0ea5e9" };
            if (score < 30) return { title: "デザイナーの卵 (Designer)", color: "#10b981" };
            if (score < 40) return { title: "鷹の目 (Eagle Eye)", color: "#f59e0b" };
            if (score < 50) return { title: "色彩の魔術師 (Wizard)", color: "#ec4899" };
            return { title: "色彩の神 (God of Color)", color: "#6366f1" };
        }

        document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });

    </script>
</body>
</html>
